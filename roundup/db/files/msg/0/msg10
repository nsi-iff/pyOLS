Ok, I've cleaned this up a little bit in r107.  Not sure if it's correct, but it's 
good enough for now.