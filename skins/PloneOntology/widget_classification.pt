<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      i18n:domain="plone">
  <head><title></title></head>
  <body>

    <!-- Classification Widget -->
    <metal:view_macro define-macro="view">
        <a href="#"
	 tal:define="obj python: accessor()"
	 tal:attributes="href obj/absolute_url"
	 tal:content="python:obj.Title() or obj.absolute_url(relative=1)"
      tal:condition="python:not field.multiValued and obj is not None"></a>
      <tal:block tal:condition="python:field.multiValued"
		 tal:repeat="obj python: accessor() or []">
	<a href="#"
	   tal:attributes="href obj/absolute_url"
	   tal:content="python:obj.Title() or obj.absolute_url(relative=1)"
	tal:condition="python:obj is not None"></a><span tal:replace="string:, " tal:condition="not: repeat/obj/end"/><br />
      </tal:block>
    </metal:view_macro>

    <div metal:define-macro="edit">
     
<tal:comment replace="nothing"></tal:comment>
      <div metal:use-macro="here/widgets/field/macros/edit">
	<div metal:fill-slot="widget_body"
	     tal:define="searchterm python: request.get('searchterm','');
	                 keywords python: request.get('keywords',None);
			 accessor python:getattr(here, field.accessor);
			 old python: accessor() or [];
			 ">
	  <p tal:condition="not:old">Not yet classified</p>

	  <div  tal:condition="old"> <!-- Edit existing keywords -->
	    <p>This item is classified with the following keywords:</p>
	    <table>
	      <tr tal:repeat="item old">
	       <td><input type="checkbox" name="delKeywords:list" tal:attributes="value item/getId"/></td> 
	        <td>
	          <a tal:attributes="href item/absolute_url" tal:content="item/title_or_id"/>
	        </td>
	        <td>
	          <span tal:replace="item/description|nothing"/>
	        </td>
	      </tr>
	    </table>
	    <input type="submit" name="form.button.delete" value="Delete"/><br>
	  </div> <!-- end editing existing keywords -->

	  <div> <!-- Search, add new keywords -->
	 <fieldset>   <legend>use this in order to search and select keywords if the above javascript-search does not work</legend>
	<input type="text"
	       name="searchterm"
	       value=""
	       id="searchterm"
	       size="30"
	       tabindex="#"
               onfocus="loadHandler(this)"
               onkeypress="activeStringStart(this)"
	       tal:attributes="value searchterm|nothing;
                               tabindex tabindex/next;"
	       />
	    <input type="submit" name="form.button.search3" value="Search"/>
	    <tal:block tal:condition="searchterm">
	      <tal:block tal:define="results python:here.portal_classification.searchMatchingKeywordsFor(here, searchterm, old)">

		<div tal:condition="results">
		  <table> <!-- Table Header ??? -->
		    <tr tal:repeat="item results">
		      <tal:block tal:define="cururl request/URL; 
		                             s item/title_or_id; 
					     newurl string:${cururl}?fieldset=classification&searchterm=${s}">
		      <td><input type="checkbox" name="keywords:list" tal:attributes="value item/getId"/></td>

		      <td><a tal:attributes="href newurl" tal:content="item/title_or_id"/></td>
		      <td><span tal:replace="item/description|nothing"/></td>
		      </tal:block>
		    </tr>
		  </table>
		  <input type="submit" name="form.button.add" value="Select"/><font color='#ff0000'> 'select' before 'save' or no keywords will be added </font>
		</div>

		<p tal:condition="not:results">No matching keywords found. Please try another search term.</p>
	      </tal:block>
	    </tal:block></fieldset>
	  </div> <!-- end search/add new keywords -->
	</div>
       </div>
      </div>

    <div metal:define-macro="search">
      <div metal:use-macro="here/widget_classification/macros/edit"></div>
    </div>

</body>
</html>
